name: Build RedSquare Screens (Linux)

on:
  repository_dispatch:
    types: [trigger-screens-linux-build]
  workflow_dispatch:
    inputs:
      build_id:
        description: 'ID of the build record in the database'
        required: true
      version:
        description: 'Version for this build'
        required: true
        default: '1.0.0-manual'

jobs:
  build-screens-linux:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
      - name: Get Build Info from Dispatch
        id: build_info
        run: |
          if [ -n "${{ github.event.client_payload.build_id }}" ]; then
            echo "build_id=${{ github.event.client_payload.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            echo "build_id=${{ github.event.inputs.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Update Build Status to 'In Progress'
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "in_progress",
              "logs_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "commit_hash": "${{ github.sha }}"
            }'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Build Linux Desktop App
        run: |
          npm run electron:build -- --linux --x64 --config electron-builder.json --config.compression=maximum
          
          # Check if build was successful
          if [ ! -f release/*.AppImage ]; then
            echo "No AppImage file found in release directory"
            exit 1
          fi
          
          # Check file size
          file=$(ls release/*.AppImage | head -1)
          fileSize=$(stat -c%s "$file")
          fileSizeMB=$((fileSize / 1024 / 1024))
          echo "Built AppImage size: ${fileSizeMB}MB"
          
          if [ $fileSize -gt 500000000 ]; then
            echo "Warning: File size (${fileSizeMB}MB) exceeds 500MB limit"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload AppImage as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screens-linux-app
          path: release/*.AppImage

      - name: Create GitHub Release and Upload AppImage
        id: upload_appimage
        run: |
          FILE_PATH=$(ls release/*.AppImage | head -1)
          if [ -z "$FILE_PATH" ]; then
            echo "No AppImage file found"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s "$FILE_PATH")
          FILE_SIZE_MB=$(echo "scale=2; $FILE_SIZE / 1024 / 1024" | bc)
          echo "AppImage file size: ${FILE_SIZE_MB}MB - using GitHub Releases for large files"
          
          # Create a unique tag for this build
          TAG="screens-linux-v${{ steps.build_info.outputs.version }}"
          RELEASE_NAME="RedSquare Screens Linux v${{ steps.build_info.outputs.version }}"
          
          # Escape special characters for JSON
          ESCAPED_FILE_SIZE=$(echo "$FILE_SIZE_MB" | sed 's/"/\\"/g')
          
          # Create GitHub Release with proper error handling
          HTTP_STATUS=$(curl -s -w "%{http_code}" -X POST \
            "https://api.github.com/repos/${{ github.repository }}/releases" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            -d "{
              \"tag_name\": \"$TAG\",
              \"target_commitish\": \"${{ github.sha }}\",
              \"name\": \"$RELEASE_NAME\",
              \"body\": \"Automated build of RedSquare Screens for Linux\\n\\nCommit: ${{ github.sha }}\\nFile size: ${ESCAPED_FILE_SIZE}MB\",
              \"draft\": false,
              \"prerelease\": true
            }" \
            -o /tmp/release_response.json)
          
          echo "GitHub Release API Status: $HTTP_STATUS"
          
          # Read the response body from file
          RESPONSE_BODY=$(cat /tmp/release_response.json)
          
          if [ "$HTTP_STATUS" != "201" ]; then
            echo "Failed to create GitHub release. HTTP Status: $HTTP_STATUS"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
          
          # Parse response
          UPLOAD_URL=$(echo "$RESPONSE_BODY" | jq -r '.upload_url' | sed 's/{.*}//')
          RELEASE_URL=$(echo "$RESPONSE_BODY" | jq -r '.html_url')
          
          if [ -z "$UPLOAD_URL" ] || [ "$UPLOAD_URL" = "null" ]; then
            echo "Failed to get upload URL from release response"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
          
          echo "Created GitHub Release: $RELEASE_URL"
          echo "Upload URL: $UPLOAD_URL"
          
          # Upload asset to the release
          ASSET_NAME="RedSquare-Screens-Linux-v${{ steps.build_info.outputs.version }}.AppImage"
          echo "Uploading asset: $ASSET_NAME"
          
          UPLOAD_HTTP_STATUS=$(curl -s -w "%{http_code}" -X POST \
            "${UPLOAD_URL}?name=${ASSET_NAME}&label=Linux%20Desktop%20App" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$FILE_PATH" \
            -o /tmp/upload_response.json)
          
          echo "Upload API Status: $UPLOAD_HTTP_STATUS"
          
          # Read the upload response body from file
          UPLOAD_BODY=$(cat /tmp/upload_response.json)
          
          if [ "$UPLOAD_HTTP_STATUS" != "201" ]; then
            echo "Failed to upload asset. HTTP Status: $UPLOAD_HTTP_STATUS"
            echo "Response: $UPLOAD_BODY"
            exit 1
          fi
          
          DOWNLOAD_URL=$(echo "$UPLOAD_BODY" | jq -r '.browser_download_url')
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "Failed to get download URL from upload response"
            echo "Response: $UPLOAD_BODY"
            exit 1
          fi
          
          echo "Asset uploaded successfully: $DOWNLOAD_URL"
          echo "artifact_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

      - name: Update Build Status to 'Success'
        if: success()
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "success",
              "artifact_url": "${{ steps.upload_appimage.outputs.artifact_url }}"
            }'

      - name: Update Build Status to 'Failed'
        if: failure() || cancelled()
        run: |
          STATUS="failed"
          if [ "${{ job.status }}" == "cancelled" ]; then
            STATUS="cancelled"
          fi
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "'$STATUS'"
            }'