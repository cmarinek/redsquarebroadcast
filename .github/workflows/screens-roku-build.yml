name: Build RedSquare Screens (Roku)

on:
  repository_dispatch:
    types: [trigger-screens-roku-build]
  workflow_dispatch:
    inputs:
      build_id:
        description: 'ID of the build record in the database'
        required: true
      version:
        description: 'Version for this build'
        required: true
        default: '1.0.0-manual'

jobs:
  build-screens-roku:
    runs-on: ubuntu-latest
    steps:
      - name: Get Build Info from Dispatch
        id: build_info
        run: |
          if [ -n "${{ github.event.client_payload.build_id }}" ]; then
            echo "build_id=${{ github.event.client_payload.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            echo "build_id=${{ github.event.inputs.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Update Build Status to 'In Progress'
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "in_progress",
              "logs_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "commit_hash": "${{ github.sha }}"
            }'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Build Web App
        run: npm run build

      - name: Create Roku Channel Package
        run: |
          # Create Roku-specific build structure
          mkdir -p roku-build/components
          mkdir -p roku-build/source
          mkdir -p roku-build/images
          
          # Create manifest file for Roku
          cat > roku-build/manifest << EOF
          title=RedSquare Screens
          major_version=1
          minor_version=0
          build_version=${{ steps.build_info.outputs.version }}
          mm_icon_focus_hd=pkg:/images/icon_focus_hd.png
          mm_icon_side_hd=pkg:/images/icon_side_hd.png
          splash_screen_hd=pkg:/images/splash_hd.jpg
          ui_resolutions=hd
          EOF
          
          # Create main BrightScript file
          cat > roku-build/source/main.brs << 'EOF'
          sub Main()
              screen = CreateObject("roSGScreen")
              m.port = CreateObject("roMessagePort")
              screen.setMessagePort(m.port)
              
              scene = screen.CreateScene("RedSquareScene")
              screen.show()
              
              while true
                  msg = wait(0, m.port)
                  msgType = type(msg)
                  if msgType = "roSGScreenEvent"
                      if msg.isScreenClosed() then return
                  end if
              end while
          end sub
          EOF
          
          # Create scene component
          cat > roku-build/components/RedSquareScene.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8" ?>
          <component name="RedSquareScene" extends="Scene">
            <script type="text/brightscript" uri="pkg:/components/RedSquareScene.brs" />
          </component>
          EOF
          
          cat > roku-build/components/RedSquareScene.brs << 'EOF'
          sub init()
              m.top.backgroundURI = ""
              m.top.backgroundColor = "0x000000"
              
              ' Create a simple label for now
              label = createObject("roSGNode", "Label")
              label.text = "RedSquare Screens - Coming Soon"
              label.translation = [640, 360]
              label.horizAlign = "center"
              label.vertAlign = "center"
              label.color = "0xFFFFFF"
              label.font.size = 48
              m.top.appendChild(label)
          end sub
          EOF
          
          # Create placeholder images (1x1 pixel PNG)
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > roku-build/images/icon_focus_hd.png
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > roku-build/images/icon_side_hd.png
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > roku-build/images/splash_hd.jpg
          
          # Create ZIP package
          cd roku-build
          zip -r ../screens-roku-app-v${{ steps.build_info.outputs.version }}.zip .
          cd ..

      - name: Upload Roku Package as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screens-roku-app
          path: screens-roku-app-v${{ steps.build_info.outputs.version }}.zip

      - name: Upload Roku Package to Supabase Storage
        id: upload_roku
        run: |
          FILE_PATH="screens-roku-app-v${{ steps.build_info.outputs.version }}.zip"
          FILE_NAME="screens-roku-app-v${{ steps.build_info.outputs.version }}.zip"
          SUPABASE_BUCKET="tv-files"

          BUCKET_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/${SUPABASE_BUCKET}/${FILE_NAME}"
          echo "artifact_url=$BUCKET_URL" >> $GITHUB_OUTPUT

          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/${SUPABASE_BUCKET}/${FILE_NAME}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/zip" \
            --data-binary @"$FILE_PATH"

      - name: Update Build Status to 'Success'
        if: success()
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "success",
              "artifact_url": "${{ steps.upload_roku.outputs.artifact_url }}"
            }'

      - name: Update Build Status to 'Failed'
        if: failure() || cancelled()
        run: |
          STATUS="failed"
          if [ "${{ job.status }}" == "cancelled" ]; then
            STATUS="cancelled"
          fi
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "'$STATUS'"
            }'