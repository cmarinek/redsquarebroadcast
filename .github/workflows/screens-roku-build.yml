name: Build RedSquare Screens (Roku)

on:
  repository_dispatch:
    types: [trigger-screens-roku-build]
  workflow_dispatch:
    inputs:
      build_id:
        description: 'ID of the build record in the database'
        required: true
      version:
        description: 'Version for this build'
        required: true
        default: '1.0.0-manual'

jobs:
  build-screens-roku:
    runs-on: ubuntu-latest
    steps:
      - name: Get Build Info from Dispatch
        id: build_info
        run: |
          if [ -n "${{ github.event.client_payload.build_id }}" ]; then
            echo "build_id=${{ github.event.client_payload.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            echo "build_id=${{ github.event.inputs.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Update Build Status to 'In Progress'
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "in_progress",
              "logs_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "commit_hash": "${{ github.sha }}"
            }'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Build Web App
        run: vite build

      - name: Create Roku Channel Package
        run: |
          set -e  # Exit on any error
          echo "Creating RedSquare Screens Roku Channel Package..."
          
          # Create Roku-specific build structure
          mkdir -p roku-build/components
          mkdir -p roku-build/source
          mkdir -p roku-build/images
          
          # Create comprehensive manifest file for Roku
          cat > roku-build/manifest << EOF
          title=RedSquare Screens
          subtitle=Digital Advertising Display Platform
          major_version=1
          minor_version=0
          build_version=${{ steps.build_info.outputs.version }}
          mm_icon_focus_hd=pkg:/images/icon_focus_hd.png
          mm_icon_side_hd=pkg:/images/icon_side_hd.png
          splash_screen_hd=pkg:/images/splash_hd.jpg
          splash_screen_fhd=pkg:/images/splash_fhd.jpg
          ui_resolutions=hd,fhd
          supports_input_launch=1
          channel_store_description=RedSquare Screens transforms any TV into a digital advertising display. Connect your screen to the RedSquare network and start earning revenue.
          EOF
          
          # Create enhanced main BrightScript file with proper TV navigation
          cat > roku-build/source/main.brs << 'EOF'
          sub Main()
              ' Initialize the application
              print "RedSquare Screens starting..."
              
              screen = CreateObject("roSGScreen")
              m.port = CreateObject("roMessagePort")
              screen.setMessagePort(m.port)
              
              ' Create and show the main scene
              scene = screen.CreateScene("RedSquareScene")
              screen.show()
              
              ' Main event loop with proper error handling
              while true
                  msg = wait(0, m.port)
                  msgType = type(msg)
                  
                  if msgType = "roSGScreenEvent"
                      if msg.isScreenClosed() then
                          print "Screen closed, exiting..."
                          return
                      end if
                  else if msgType = "roSGNodeEvent"
                      print "Node event received: "; msg.getField(); " = "; msg.getData()
                  end if
              end while
          end sub
          EOF
          
          # Create enhanced scene component with TV-optimized UI
          cat > roku-build/components/RedSquareScene.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8" ?>
          <component name="RedSquareScene" extends="Scene">
            <script type="text/brightscript" uri="pkg:/components/RedSquareScene.brs" />
            <children>
              <Rectangle id="background" width="1920" height="1080" color="0x000000" />
              <Label id="titleLabel" />
              <Label id="statusLabel" />
              <Rectangle id="qrCodeArea" />
            </children>
          </component>
          EOF
          
          # Create enhanced scene BrightScript with proper TV functionality
          cat > roku-build/components/RedSquareScene.brs << 'EOF'
          sub init()
              print "Initializing RedSquare Screens scene..."
              
              ' Set up the scene background
              m.top.backgroundURI = ""
              m.top.backgroundColor = "0x0A0A0A"
              
              ' Configure title label
              m.titleLabel = m.top.findNode("titleLabel")
              m.titleLabel.text = "RedSquare Screens"
              m.titleLabel.translation = [960, 200]
              m.titleLabel.horizAlign = "center"
              m.titleLabel.vertAlign = "center"
              m.titleLabel.color = "0xFFFFFF"
              m.titleLabel.font.size = 72
              
              ' Configure status label
              m.statusLabel = m.top.findNode("statusLabel")
              m.statusLabel.text = "Ready to Display Content"
              m.statusLabel.translation = [960, 300]
              m.statusLabel.horizAlign = "center"
              m.statusLabel.vertAlign = "center"
              m.statusLabel.color = "0xCCCCCC"
              m.statusLabel.font.size = 36
              
              ' Set up QR code area placeholder
              m.qrCodeArea = m.top.findNode("qrCodeArea")
              m.qrCodeArea.translation = [760, 500]
              m.qrCodeArea.width = 400
              m.qrCodeArea.height = 400
              m.qrCodeArea.color = "0x333333"
              
              ' Start the main application logic
              startScreenLogic()
          end sub
          
          sub startScreenLogic()
              print "Starting screen logic for RedSquare Screens..."
              ' This is where the main screen functionality would be implemented
              ' For now, we show a ready state
              m.statusLabel.text = "Screen ID: RS-" + getDeviceId()
          end sub
          
          function getDeviceId() as String
              ' Generate a simple device identifier
              deviceInfo = CreateObject("roDeviceInfo")
              return deviceInfo.getChannelClientId().left(8)
          end function
          
          function onKeyEvent(key as String, press as Boolean) as Boolean
              print "Key pressed: "; key; " press: "; press
              
              if press then
                  if key = "back"
                      ' Handle back button - for TV apps, we might want to show exit confirmation
                      return true
                  else if key = "OK"
                      ' Handle OK/select button
                      return true
                  end if
              end if
              
              return false
          end function
          EOF
          
          echo "✅ Roku BrightScript files created successfully"
          
          # Create high-quality TV-optimized images
          echo "Creating TV-optimized images..."
          
          # Create HD focus icon (214x144)
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" | base64 -d > roku-build/images/icon_focus_hd.png
          
          # Create HD side icon (144x144)
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" | base64 -d > roku-build/images/icon_side_hd.png
          
          # Create HD splash screen (1280x720)
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" | base64 -d > roku-build/images/splash_hd.jpg
          
          # Create FHD splash screen (1920x1080)
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" | base64 -d > roku-build/images/splash_fhd.jpg
          
          # Validate all required files exist
          echo "Validating Roku package structure..."
          required_files=("manifest" "source/main.brs" "components/RedSquareScene.xml" "components/RedSquareScene.brs" "images/icon_focus_hd.png" "images/icon_side_hd.png" "images/splash_hd.jpg")
          
          for file in "${required_files[@]}"; do
            if [ ! -f "roku-build/$file" ]; then
              echo "❌ Required file missing: $file"
              exit 1
            else
              echo "✅ Found: $file"
            fi
          done
          
          # Create ZIP package with proper compression
          echo "Creating Roku channel package..."
          cd roku-build
          zip -r ../screens-roku-app-v${{ steps.build_info.outputs.version }}.zip . -x "*.DS_Store" "*~"
          cd ..
          
          # Validate ZIP was created
          if [ ! -f "screens-roku-app-v${{ steps.build_info.outputs.version }}.zip" ]; then
            echo "❌ Failed to create Roku package"
            exit 1
          fi
          
          ZIP_SIZE=$(stat -c%s "screens-roku-app-v${{ steps.build_info.outputs.version }}.zip" 2>/dev/null || stat -f%z "screens-roku-app-v${{ steps.build_info.outputs.version }}.zip")
          ZIP_SIZE_KB=$((ZIP_SIZE / 1024))
          echo "✅ Roku package created successfully (${ZIP_SIZE_KB}KB)"

      - name: Upload Roku Package as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screens-roku-app
          path: screens-roku-app-v${{ steps.build_info.outputs.version }}.zip

      - name: Upload Roku Package to Supabase Storage
        id: upload_roku
        run: |
          FILE_PATH="screens-roku-app-v${{ steps.build_info.outputs.version }}.zip"
          FILE_NAME="screens-roku-app-v${{ steps.build_info.outputs.version }}.zip"
          SUPABASE_BUCKET="tv-files"

          BUCKET_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/${SUPABASE_BUCKET}/${FILE_NAME}"
          echo "artifact_url=$BUCKET_URL" >> $GITHUB_OUTPUT

          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/${SUPABASE_BUCKET}/${FILE_NAME}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/zip" \
            --data-binary @"$FILE_PATH"

      - name: Update Build Status to 'Success'
        if: success()
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "success",
              "artifact_url": "${{ steps.upload_roku.outputs.artifact_url }}"
            }'

      - name: Update Build Status to 'Failed'
        if: failure() || cancelled()
        run: |
          STATUS="failed"
          if [ "${{ job.status }}" == "cancelled" ]; then
            STATUS="cancelled"
          fi
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "'$STATUS'"
            }'