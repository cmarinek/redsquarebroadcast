name: Build RedSquare Screens (iOS)

on:
  repository_dispatch:
    types: [trigger-screens-ios-build]
  workflow_dispatch:
    inputs:
      build_id:
        description: 'ID of the build record in the database'
        required: true
      version:
        description: 'Version for this build'
        required: true
        default: '1.0.0-manual'

env:
  VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
  VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
  VITE_SUPABASE_PROJECT_ID: ${{ secrets.VITE_SUPABASE_PROJECT_ID }}
  VITE_MAPBOX_PUBLIC_TOKEN: ${{ secrets.VITE_MAPBOX_PUBLIC_TOKEN }}
  VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
  SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  MAPBOX_PUBLIC_TOKEN: ${{ secrets.VITE_MAPBOX_PUBLIC_TOKEN }}
  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
  HUGGING_FACE_ACCESS_TOKEN: ${{ secrets.HUGGING_FACE_ACCESS_TOKEN }}
  GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
  GH_REPO_OWNER: ${{ secrets.GH_REPO_OWNER }}
  GH_REPO_NAME: ${{ secrets.GH_REPO_NAME }}

jobs:
  build-screens-ios:
    runs-on: macos-latest
    steps:
      - name: Get Build Info from Dispatch
        id: build_info
        run: |
          if [ -n "${{ github.event.client_payload.build_id }}" ]; then
            echo "build_id=${{ github.event.client_payload.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "triggered_by=${{ github.event.client_payload.triggered_by }}" >> $GITHUB_OUTPUT
            echo "commit_sha=${{ github.event.client_payload.commit_sha }}" >> $GITHUB_OUTPUT
          else
            echo "build_id=${{ github.event.inputs.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "triggered_by=manual" >> $GITHUB_OUTPUT
            echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
          
          echo "ðŸ“‹ Build Info:"
          echo "  - Build ID: $(cat $GITHUB_OUTPUT | grep build_id | cut -d= -f2)"
          echo "  - Version: $(cat $GITHUB_OUTPUT | grep version | cut -d= -f2)"
          echo "  - Triggered by: $(cat $GITHUB_OUTPUT | grep triggered_by | cut -d= -f2)"

      - name: Update Build Status to 'In Progress'
        if: "!startsWith(steps.build_info.outputs.build_id, 'auto-')"
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "in_progress",
              "logs_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "commit_hash": "${{ github.sha }}"
            }'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Build Web App
        run: npm run build:mobile
        env:
          VITE_BUILD_TARGET: mobile
          VITE_CAPACITOR: 'true'

      - name: Validate build assets
        run: |
          echo "Checking for absolute asset paths in build..."
          if grep -r '"/assets' dist/ 2>/dev/null; then
            echo "âŒ Found absolute /assets paths in build - this will cause issues in Capacitor apps"
            echo "Build artifacts should use relative paths for compatibility"
            exit 1
          fi
          echo "âœ… Build validation passed - no absolute asset paths found"

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Import Code Signing Certificate
        if: env.IOS_CERTIFICATE_BASE64 != ''
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        run: |
          # Create keychain for code signing
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          echo "Creating temporary keychain..."
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          echo "Importing signing certificate..."
          CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
          echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
          
          security import "$CERTIFICATE_PATH" \
            -P "$IOS_CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          echo "âœ… Code signing certificate imported successfully"

      - name: Import Provisioning Profile
        if: env.IOS_PROVISIONING_PROFILE_BASE64 != ''
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          echo "Installing provisioning profile..."
          PROFILE_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"
          
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp "$PROFILE_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/
          
          # Extract UUID for verification
          PROFILE_UUID=$(grep -a -A 1 'UUID' "$PROFILE_PATH" | grep string | sed -e 's/<string>//' -e 's/<\/string>//' | tr -d '\t ')
          echo "Provisioning Profile UUID: $PROFILE_UUID"
          
          echo "âœ… Provisioning profile installed successfully"

      - name: Setup Capacitor iOS Platform
        run: |
          if [ ! -f "ios/App/App.xcodeproj/project.pbxproj" ]; then
            echo "iOS project incomplete, removing and re-adding platform"
            rm -rf ios
            npx cap add ios
          else
            echo "iOS platform properly configured, skipping add"
          fi

      - name: Sync Capacitor Project
        run: npx cap sync ios

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
          cd ios/App
          pod install --repo-update

      - name: Install iOS Platform
        run: |
          echo "Using latest Xcode set up by setup-xcode action"
          xcodebuild -version
          echo "âœ… Xcode configuration verified"

      - name: Build iOS Screens App
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
        run: |
          set -e  # Exit on any error
          echo "Building RedSquare Screens iOS App..."
          cd ios/App
          
          # Clean previous builds
          xcodebuild clean -workspace App.xcworkspace -scheme App
          
          # Determine if we should use code signing
          USE_CODE_SIGNING="NO"
          if [ -n "${{ secrets.IOS_CERTIFICATE_BASE64 }}" ] && [ -n "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" ]; then
            USE_CODE_SIGNING="YES"
            echo "âœ… Code signing enabled"
          else
            echo "âš ï¸ Code signing disabled (development build only)"
          fi
          
          # Build with or without code signing
          if [ "$USE_CODE_SIGNING" = "YES" ]; then
            echo "Building with code signing for App Store distribution..."
            xcodebuild -workspace App.xcworkspace \
              -scheme App \
              -configuration Release \
              -destination 'generic/platform=iOS' \
              -archivePath App.xcarchive \
              archive \
              DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
              PRODUCT_BUNDLE_IDENTIFIER="$IOS_BUNDLE_ID" \
              CODE_SIGN_STYLE=Manual \
              -allowProvisioningUpdates \
              -quiet
          else
            echo "Building without code signing (development only)..."
            xcodebuild -workspace App.xcworkspace \
              -scheme App \
              -configuration Release \
              -destination 'generic/platform=iOS' \
              -archivePath App.xcarchive \
              archive \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              -quiet
          fi
            
          # Validate archive was created
          if [ ! -d "App.xcarchive" ]; then
            echo "âŒ iOS archive not created"
            exit 1
          fi
          
          echo "âœ… iOS archive created successfully"

      - name: Export IPA
        run: |
          set -e  # Exit on any error
          echo "Exporting iOS IPA..."
          cd ios/App
          
          # Determine export method
          if [ -n "${{ secrets.IOS_CERTIFICATE_BASE64 }}" ] && [ -n "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" ]; then
            EXPORT_METHOD="app-store"
            echo "Using app-store export method for signed build"
            
            # Create export options plist for App Store
            cat > ExportOptions.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>method</key>
  <string>app-store</string>
  <key>teamID</key>
  <string>${{ secrets.IOS_TEAM_ID }}</string>
  <key>uploadSymbols</key>
  <true/>
  <key>compileBitcode</key>
  <false/>
</dict>
</plist>
EOF
            
            xcodebuild -exportArchive \
              -archivePath App.xcarchive \
              -exportPath Export \
              -exportOptionsPlist ExportOptions.plist \
              -allowProvisioningUpdates \
              -quiet
          else
            echo "Using development export method (no signing)"
            
            # Create export options plist for development
            cat > ExportOptions.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>method</key>
  <string>development</string>
  <key>compileBitcode</key>
  <false/>
</dict>
</plist>
EOF
            
            xcodebuild -exportArchive \
              -archivePath App.xcarchive \
              -exportPath Export \
              -exportOptionsPlist ExportOptions.plist \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              -quiet
          fi
            
          # Validate IPA was created
          if [ ! -f "Export/App.ipa" ]; then
            echo "âŒ IPA file not created"
            exit 1
          fi
          
          IPA_SIZE=$(stat -f%z "Export/App.ipa" 2>/dev/null || stat -c%s "Export/App.ipa")
          IPA_SIZE_MB=$((IPA_SIZE / 1024 / 1024))
          
          echo "âœ… iOS IPA exported successfully (${IPA_SIZE_MB}MB)"
          
          # Validate IPA size
          if [ $IPA_SIZE_MB -gt 200 ]; then
            echo "âš ï¸ Warning: IPA size is quite large (${IPA_SIZE_MB}MB)"
          fi

      - name: Upload IPA as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screens-ios-app
          path: ios/App/Export/App.ipa

      - name: Upload IPA to Supabase Storage
        id: upload_ipa
        run: |
          FILE_PATH="ios/App/Export/App.ipa"
          FILE_NAME="screens-ios-app-v${{ steps.build_info.outputs.version }}.ipa"
          SUPABASE_BUCKET="ios-files"

          BUCKET_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/${SUPABASE_BUCKET}/${FILE_NAME}"
          echo "artifact_url=$BUCKET_URL" >> $GITHUB_OUTPUT

          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/${SUPABASE_BUCKET}/${FILE_NAME}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$FILE_PATH"

      - name: Setup App Store Connect API Key
        if: env.APP_STORE_CONNECT_API_KEY_BASE64 != '' && env.IOS_CERTIFICATE_BASE64 != ''
        env:
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          echo "Setting up App Store Connect API key for TestFlight upload..."
          
          # Create private_keys directory
          mkdir -p ~/private_keys
          
          # Decode and save the API key
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > ~/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
          
          echo "âœ… App Store Connect API key configured"

      - name: Upload to TestFlight
        if: env.APP_STORE_CONNECT_API_KEY_BASE64 != '' && env.IOS_CERTIFICATE_BASE64 != ''
        env:
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          set -e  # Exit on any error
          echo "ðŸ“¤ Uploading IPA to TestFlight..."
          
          IPA_PATH="ios/App/Export/App.ipa"
          
          # Validate TestFlight upload using xcrun altool
          echo "Validating IPA for App Store submission..."
          xcrun altool --validate-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID" \
            --verbose
          
          echo "âœ… Validation successful"
          
          # Upload to TestFlight
          echo "Uploading to TestFlight..."
          xcrun altool --upload-app \
            --type ios \
            --file "$IPA_PATH" \
            --apiKey "$APP_STORE_CONNECT_API_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_API_ISSUER_ID" \
            --verbose
          
          echo "âœ… Successfully uploaded to TestFlight!"
          echo ""
          echo "ðŸ“± The build will appear in App Store Connect within 5-10 minutes."
          echo "ðŸ§ª Once processed, you can distribute to testers via TestFlight."
          
          # Set output for build summary
          echo "testflight_uploaded=true" >> $GITHUB_OUTPUT
        id: testflight_upload

      - name: Update Build Status to 'Success'
        if: success() && !startsWith(steps.build_info.outputs.build_id, 'auto-')
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "success",
              "artifact_url": "${{ steps.upload_ipa.outputs.artifact_url }}"
            }'

      - name: Update Build Status to 'Failed'
        if: (failure() || cancelled()) && !startsWith(steps.build_info.outputs.build_id, 'auto-')
        run: |
          STATUS="failed"
          if [ "${{ job.status }}" == "cancelled" ]; then
            STATUS="cancelled"
          fi
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "'$STATUS'"
            }'

      - name: Build Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "## âœ… iOS Mobile Build Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Build Details:**" >> $GITHUB_STEP_SUMMARY
            echo "- Build ID: \`${{ steps.build_info.outputs.build_id }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Version: \`${{ steps.build_info.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Platform: iOS Mobile" >> $GITHUB_STEP_SUMMARY
            echo "- Triggered by: ${{ steps.build_info.outputs.triggered_by }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.testflight_upload.outputs.testflight_uploaded }}" == "true" ]; then
              echo "**ðŸš€ TestFlight Deployment:**" >> $GITHUB_STEP_SUMMARY
              echo "- âœ… Uploaded to TestFlight successfully" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ“± Build will be available in App Store Connect within 5-10 minutes" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ§ª Once processed, distribute to testers in [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "**Download IPA:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to the [Artifacts section](#artifacts) above" >> $GITHUB_STEP_SUMMARY
            echo "2. Download \`screens-ios-app\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Extract and install the IPA on your iOS device" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ iOS Mobile Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Build Details:**" >> $GITHUB_STEP_SUMMARY
            echo "- Build ID: \`${{ steps.build_info.outputs.build_id }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Version: \`${{ steps.build_info.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup Keychain
        if: always()
        run: |
          if [ -f "$RUNNER_TEMP/app-signing.keychain-db" ]; then
            security delete-keychain "$RUNNER_TEMP/app-signing.keychain-db" || true
          fi