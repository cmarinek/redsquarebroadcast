name: Build RedSquare Screens (iOS)

on:
  repository_dispatch:
    types: [trigger-screens-ios-build]
  workflow_dispatch:
    inputs:
      build_id:
        description: 'ID of the build record in the database'
        required: true
      version:
        description: 'Version for this build'
        required: true
        default: '1.0.0-manual'

jobs:
  build-screens-ios:
    runs-on: macos-latest
    steps:
      - name: Get Build Info from Dispatch
        id: build_info
        run: |
          if [ -n "${{ github.event.client_payload.build_id }}" ]; then
            echo "build_id=${{ github.event.client_payload.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            echo "build_id=${{ github.event.inputs.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Update Build Status to 'In Progress'
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "in_progress",
              "logs_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "commit_hash": "${{ github.sha }}"
            }'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Build Web App
        run: npm run build:mobile
        env:
          VITE_BUILD_TARGET: mobile
          VITE_CAPACITOR: 'true'

      - name: Validate build assets
        run: |
          echo "Checking for absolute asset paths in build..."
          if grep -r '"/assets' dist/ 2>/dev/null; then
            echo "❌ Found absolute /assets paths in build - this will cause issues in Capacitor apps"
            echo "Build artifacts should use relative paths for compatibility"
            exit 1
          fi
          echo "✅ Build validation passed - no absolute asset paths found"

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Setup Capacitor iOS Platform
        run: |
          if [ ! -f "ios/App/App.xcodeproj/project.pbxproj" ]; then
            echo "iOS project incomplete, removing and re-adding platform"
            rm -rf ios
            npx cap add ios
          else
            echo "iOS platform properly configured, skipping add"
          fi

      - name: Sync Capacitor Project
        run: npx cap sync ios

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
          cd ios/App
          pod install --repo-update

      - name: Install iOS Platform
        run: |
          echo "Using latest Xcode set up by setup-xcode action"
          xcodebuild -version
          echo "✅ Xcode configuration verified"

      - name: Build iOS Screens App
        run: |
          set -e  # Exit on any error
          echo "Building RedSquare Screens iOS App..."
          cd ios/App
          
          # Clean previous builds
          xcodebuild clean -workspace App.xcworkspace -scheme App
          
          # Build with enhanced error handling
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath App.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -quiet
            
          # Validate archive was created
          if [ ! -d "App.xcarchive" ]; then
            echo "❌ iOS archive not created"
            exit 1
          fi
          
          echo "✅ iOS archive created successfully"

      - name: Export IPA
        run: |
          set -e  # Exit on any error
          echo "Exporting iOS IPA..."
          cd ios/App
          
          xcodebuild -exportArchive \
            -archivePath App.xcarchive \
            -exportPath Export \
            -exportOptionsPlist ../../build-scripts/ExportOptions.plist \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -quiet
            
          # Validate IPA was created
          if [ ! -f "Export/App.ipa" ]; then
            echo "❌ IPA file not created"
            exit 1
          fi
          
          IPA_SIZE=$(stat -c%s "Export/App.ipa" 2>/dev/null || stat -f%z "Export/App.ipa")
          IPA_SIZE_MB=$((IPA_SIZE / 1024 / 1024))
          
          echo "✅ iOS IPA exported successfully (${IPA_SIZE_MB}MB)"
          
          # Validate IPA size
          if [ $IPA_SIZE_MB -gt 200 ]; then
            echo "⚠️ Warning: IPA size is quite large (${IPA_SIZE_MB}MB)"
          fi

      - name: Upload IPA as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screens-ios-app
          path: ios/App/Export/App.ipa

      - name: Upload IPA to Supabase Storage
        id: upload_ipa
        run: |
          FILE_PATH="ios/App/Export/App.ipa"
          FILE_NAME="screens-ios-app-v${{ steps.build_info.outputs.version }}.ipa"
          SUPABASE_BUCKET="ios-files"

          BUCKET_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/${SUPABASE_BUCKET}/${FILE_NAME}"
          echo "artifact_url=$BUCKET_URL" >> $GITHUB_OUTPUT

          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/${SUPABASE_BUCKET}/${FILE_NAME}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$FILE_PATH"

      - name: Update Build Status to 'Success'
        if: success()
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "success",
              "artifact_url": "${{ steps.upload_ipa.outputs.artifact_url }}"
            }'

      - name: Update Build Status to 'Failed'
        if: failure() || cancelled()
        run: |
          STATUS="failed"
          if [ "${{ job.status }}" == "cancelled" ]; then
            STATUS="cancelled"
          fi
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "'$STATUS'"
            }'