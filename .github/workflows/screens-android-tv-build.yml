name: Build RedSquare Screens (Android TV)

on:
  repository_dispatch:
    types: [trigger-screens-android-tv-build]
  workflow_dispatch: # Allows manual triggering from the GitHub UI for testing
    inputs:
      build_id:
        description: 'ID of the build record in the database'
        required: true
      version:
        description: 'Version for this build'
        required: true
        default: '1.0.0-manual'

jobs:
  build-screens-android-tv:
    runs-on: ubuntu-latest
    steps:
      - name: Get Build Info from Dispatch
        id: build_info
        run: |
          if [ -n "${{ github.event.client_payload.build_id }}" ]; then
            echo "build_id=${{ github.event.client_payload.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            echo "build_id=${{ github.event.inputs.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Update Build Status to 'In Progress'
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            --data '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "in_progress",
              "logs_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "commit_hash": "${{ github.sha }}"
            }'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Build Web App
        run: npm run build

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Capacitor Android Platform
        run: |
          set -e  # Exit on any error
          echo "Setting up Capacitor Android Platform for TV..."
          
          # Ensure clean build environment
          rm -rf android/ || true
          
          # Ensure Capacitor is initialized
          if [ ! -f "capacitor.config.ts" ] && [ ! -f "capacitor.config.js" ]; then
            echo "Capacitor config not found, initializing..."
            npx cap init
          fi
          
          # Add Android platform fresh
          echo "Adding Android platform..."
          npx cap add android
          
          # Verify the platform was added successfully
          if [ ! -f "android/gradlew" ]; then
            echo "❌ Failed to create Android platform"
            exit 1
          fi
          
          echo "✅ Android platform setup completed"

      - name: Sync Capacitor Project
        run: |
          set -e  # Exit on any error
          echo "Syncing Capacitor project for Android TV..."
          
          npx cap sync android
          
          # Ensure gradlew is executable
          if [ -f "android/gradlew" ]; then
            chmod +x android/gradlew
            echo "✅ Android gradlew found and made executable"
          else
            echo "❌ gradlew still not found after sync"
            exit 1
          fi

      - name: Configure Android Build for TV
        run: |
          set -e  # Exit on any error
          echo "Configuring Android build for Android TV..."
          
          # Ensure Android project exists
          if [ ! -f "android/app/src/main/AndroidManifest.xml" ]; then
            echo "❌ Android manifest not found"
            exit 1
          fi
          
          # Create Android TV banner asset
          echo "Creating Android TV banner..."
          mkdir -p android/app/src/main/res/drawable-xhdpi
          
          # Create a simple banner placeholder (320x180 px for Android TV)
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" | base64 -d > android/app/src/main/res/drawable-xhdpi/banner.png
          
          # Configure AndroidManifest.xml for Android TV
          echo "Setting up Android TV-specific configurations..."
          
          # Remove touchscreen requirement for TV
          if grep -q 'android:name="android.hardware.touchscreen"' android/app/src/main/AndroidManifest.xml; then
            sed -i 's/android:name="android.hardware.touchscreen" android:required="true"/android:name="android.hardware.touchscreen" android:required="false"/' android/app/src/main/AndroidManifest.xml
          else
            sed -i '/<\/manifest>/i\    <uses-feature android:name="android.hardware.touchscreen" android:required="false" />' android/app/src/main/AndroidManifest.xml
          fi
          
          # Add Android TV launcher support (LEANBACK_LAUNCHER)
          if ! grep -q "android.intent.category.LEANBACK_LAUNCHER" android/app/src/main/AndroidManifest.xml; then
            sed -i '/<category android:name="android.intent.category.LAUNCHER"\/>/a\                <category android:name="android.intent.category.LEANBACK_LAUNCHER" />' android/app/src/main/AndroidManifest.xml
            echo "✅ Added LEANBACK_LAUNCHER category for Android TV"
          fi
          
          # Add Android TV banner to application
          if ! grep -q 'android:banner=' android/app/src/main/AndroidManifest.xml; then
            sed -i 's/<application/& android:banner="@drawable\/banner"/' android/app/src/main/AndroidManifest.xml
            echo "✅ Added TV banner to application"
          fi
          
          # Add Android TV feature requirements and permissions
          TV_FEATURES='    <!-- Android TV Requirements -->
      <uses-feature android:name="android.software.leanback" android:required="true" />
      <uses-feature android:name="android.hardware.touchscreen" android:required="false" />
      <uses-feature android:name="android.hardware.faketouch" android:required="false" />
      <uses-feature android:name="android.hardware.telephony" android:required="false" />
      <uses-feature android:name="android.hardware.camera" android:required="false" />
      <uses-feature android:name="android.hardware.bluetooth" android:required="false" />
      <uses-feature android:name="android.hardware.nfc" android:required="false" />
      <uses-feature android:name="android.hardware.location" android:required="false" />
      <uses-feature android:name="android.hardware.location.gps" android:required="false" />
      <uses-feature android:name="android.hardware.microphone" android:required="false" />
      <!-- TV Display Features -->
      <uses-feature android:name="android.hardware.hdmi.cec" android:required="false" />
      <uses-feature android:name="android.software.live_tv" android:required="false" />
      
      <!-- Android TV Permissions -->
      <uses-permission android:name="android.permission.INTERNET" />
      <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
      <uses-permission android:name="android.permission.WAKE_LOCK" />
      <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />'
          
          if ! grep -q 'android:name="android.software.leanback"' android/app/src/main/AndroidManifest.xml; then
            sed -i "/<\/manifest>/i\\$TV_FEATURES" android/app/src/main/AndroidManifest.xml
            echo "✅ Added Android TV feature requirements and permissions"
          fi
          
          # Configure landscape orientation for TV
          sed -i 's/android:screenOrientation="[^"]*"/android:screenOrientation="sensorLandscape"/' android/app/src/main/AndroidManifest.xml || echo "Orientation already configured"
          
          # Add TV-optimized activity attributes
          if ! grep -q 'android:launchMode="singleTask"' android/app/src/main/AndroidManifest.xml; then
            sed -i 's/<activity/& android:launchMode="singleTask"/' android/app/src/main/AndroidManifest.xml
            echo "✅ Added TV-optimized activity launch mode"
          fi
          
          # Ensure the app can handle D-pad navigation
          if ! grep -q 'configChanges.*keyboardHidden' android/app/src/main/AndroidManifest.xml; then
            sed -i 's/android:configChanges="[^"]*"/android:configChanges="orientation|keyboardHidden|keyboard|screenSize|uiMode"/' android/app/src/main/AndroidManifest.xml || echo "ConfigChanges already optimized"
          fi
          
          echo "✅ Android TV configuration completed successfully"

      - name: Create Android Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_SIGNING_KEY_BASE64 }}
        run: |
          set -e  # Exit on any error
          echo "Setting up Android keystore for signing..."
          
          if [ ! -z "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > android/app/release.keystore
            echo "✅ Production keystore configured"
          else
            echo "⚠️  No production keystore provided, using debug signing"
          fi

      - name: Build RedSquare Screens Android TV APK
        run: |
          set -e  # Exit on any error
          echo "Building RedSquare Screens for Android TV..."
          
          cd android
          
          # Verify gradlew exists before attempting to use it
          if [ ! -f "./gradlew" ]; then
            echo "❌ gradlew not found in android directory"
            echo "Contents of android directory:"
            ls -la
            exit 1
          fi
          
          # Ensure gradlew is executable
          chmod +x ./gradlew
          
          # Clean previous builds
          ./gradlew clean
          
          # Build release APK
          ./gradlew assembleRelease
          
          echo "✅ APK build completed successfully"
          echo "Listing build outputs:"
          find . -name "*.apk" -type f
          
          # Validate APK was created
          APK_COUNT=$(find ./app/build/outputs/apk/release/ -name "*.apk" | wc -l)
          if [ "$APK_COUNT" -eq 0 ]; then
            echo "❌ No APK files were generated"
            echo "Build directory contents:"
            ls -la ./app/build/outputs/apk/release/ || echo "Release directory doesn't exist"
            echo "Full outputs directory:"
            ls -la ./app/build/outputs/ || echo "Outputs directory doesn't exist"
            exit 1
          fi
          
          echo "✅ Found $APK_COUNT APK file(s) ready for Android TV"
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}

      - name: Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screens-android-tv-app
          path: android/app/build/outputs/apk/release/*.apk

      - name: Upload APK to Supabase Storage
        id: upload_apk
        run: |
          set -e  # Exit on any error
          echo "Uploading Android TV APK to storage..."
          
          # Find the actual APK file
          FILE_PATH=$(find android/app/build/outputs/apk/release/ -name "*.apk" | head -1)
          if [ -z "$FILE_PATH" ]; then
            echo "❌ No APK file found in release directory"
            exit 1
          fi
          echo "Found APK: $FILE_PATH"
          
          # Get file size for logging
          FILE_SIZE=$(stat -c%s "$FILE_PATH" 2>/dev/null || stat -f%z "$FILE_PATH")
          FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
          echo "APK size: ${FILE_SIZE_MB}MB"
          
          FILE_NAME="screens-android-tv-app-v${{ steps.build_info.outputs.version }}.apk"
          SUPABASE_BUCKET="tv-files"

          # Get the public URL of the bucket
          BUCKET_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/${SUPABASE_BUCKET}/${FILE_NAME}"
          echo "artifact_url=$BUCKET_URL" >> $GITHUB_OUTPUT

          # Upload to Supabase Storage
          HTTP_STATUS=$(curl -s -w "%{http_code}" -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/${SUPABASE_BUCKET}/${FILE_NAME}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/vnd.android.package-archive" \
            --data-binary @"$FILE_PATH" \
            -o /tmp/upload_response.txt)
          
          echo "Upload HTTP Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "❌ Failed to upload APK. Status: $HTTP_STATUS"
            cat /tmp/upload_response.txt || echo "No response body"
            exit 1
          fi
          
          echo "✅ Android TV APK uploaded successfully (${FILE_SIZE_MB}MB)"

      - name: Update Build Status to 'Success'
        if: success()
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            --data '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "success",
              "artifact_url": "${{ steps.upload_apk.outputs.artifact_url }}"
            }'

      - name: Update Build Status to 'Failed'
        if: failure() || cancelled()
        run: |
          STATUS="failed"
          if [ "${{ job.status }}" == "cancelled" ]; then
            STATUS="cancelled"
          fi
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            --data-binary '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "'$STATUS'"
            }'
