name: Build Advertiser Android App

on:
  repository_dispatch:
    types: [trigger-advertiser_android-build]
  workflow_dispatch:
    inputs:
      build_id:
        description: 'ID of the build record in the database'
        required: true
      version:
        description: 'Version for this build'
        required: true
        default: '1.0.0-advertiser-android'

jobs:
  build-advertiser-android:
    runs-on: ubuntu-latest
    steps:
      - name: Get Build Info from Dispatch
        id: build_info
        run: |
          if [ -n "${{ github.event.client_payload.build_id }}" ]; then
            echo "build_id=${{ github.event.client_payload.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            echo "build_id=${{ github.event.inputs.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Update Build Status to 'In Progress'
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            --data '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "in_progress",
              "logs_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "commit_hash": "${{ github.sha }}"
            }'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install

      - name: Build Advertiser Web App
        run: npm run build
        env:
          VITE_APP_TYPE: advertiser
          VITE_PLATFORM: android

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Configure Capacitor for Advertiser App
        run: |
          # Update capacitor.config.ts for advertiser app
          if [ -f "capacitor.config.ts" ]; then
            sed -i 's/appId: "app.lovable.5108753008cd41c59bc4bc6e5c990b78"/appId: "app.redsquare.advertiser"/' capacitor.config.ts
            sed -i 's/appName: "redsquarebroadcast"/appName: "RedSquare Advertiser"/' capacitor.config.ts
          else
            echo "capacitor.config.ts not found"
            exit 1
          fi

      - name: Setup Capacitor Android Platform
        run: |
          echo "=== DEBUG: Current working directory ==="
          pwd
          ls -la
          
          echo "=== DEBUG: Checking Capacitor configuration ==="
          if [ -f "capacitor.config.ts" ]; then
            cat capacitor.config.ts
          else
            echo "ERROR: capacitor.config.ts not found"
            exit 1
          fi
          
          echo "=== DEBUG: Checking if built web app exists ==="
          if [ -d "dist" ]; then
            echo "dist directory found"
            ls -la dist/
          else
            echo "ERROR: dist directory not found - web app needs to be built first"
            exit 1
          fi
          
          echo "=== DEBUG: Removing any existing android directory ==="
          rm -rf android
          
          echo "=== DEBUG: Installing Capacitor if needed ==="
          npm list @capacitor/android || npm install @capacitor/android
          
          echo "=== DEBUG: Checking Capacitor version ==="
          npx cap --version
          
          echo "=== DEBUG: Adding Android platform ==="
          npx cap add android
          
          echo "=== DEBUG: Verifying Android platform creation ==="
          if [ ! -d "android" ]; then
            echo "ERROR: Android directory was not created"
            echo "Available platforms:"
            npx cap list
            exit 1
          fi
          
          echo "Android directory created successfully"
          ls -la android/
          
          if [ ! -f "android/gradlew" ]; then
            echo "ERROR: gradlew was not created by Capacitor"
            echo "Trying to manually initialize gradle wrapper..."
            cd android
            
            # Check if gradle is available and try to create wrapper
            if command -v gradle &> /dev/null; then
              echo "Gradle found, creating wrapper..."
              gradle wrapper
            else
              echo "Gradle not found globally, trying with gradlew from capacitor template..."
              # Copy gradlew from node_modules if available
              if [ -f "../node_modules/@capacitor/android/android-template/gradlew" ]; then
                cp "../node_modules/@capacitor/android/android-template/gradlew" .
                cp "../node_modules/@capacitor/android/android-template/gradlew.bat" .
                mkdir -p gradle/wrapper
                cp "../node_modules/@capacitor/android/android-template/gradle/wrapper/"* gradle/wrapper/
              fi
            fi
            cd ..
            
            if [ ! -f "android/gradlew" ]; then
              echo "ERROR: Still no gradlew after manual creation attempts"
              echo "Contents of android directory:"
              find android/ -type f -name "*.gradle" -o -name "gradlew*" | head -20
              exit 1
            fi
          fi
          
          if [ ! -f "android/build.gradle" ]; then
            echo "ERROR: build.gradle was not created"
            exit 1
          fi
          
          echo "=== DEBUG: Making gradlew executable ==="
          chmod +x android/gradlew
          
          echo "=== DEBUG: Final verification ==="
          echo "Contents of android directory:"
          ls -la android/
          echo "Gradle wrapper version:"
          cd android && ./gradlew --version && cd ..

      - name: Sync Capacitor Project
        run: |
          npx cap sync android
          
          # Ensure gradlew is executable
          if [ -f "android/gradlew" ]; then
            chmod +x android/gradlew
            echo "Android gradlew found and made executable"
          else
            echo "ERROR: gradlew still not found after sync"
            exit 1
          fi

      - name: Configure Android Manifest for Advertiser
        run: |
          # Update Android manifest for advertiser-specific features
          if [ -f "android/app/src/main/res/values/strings.xml" ]; then
            sed -i 's/Red Square Broadcast/Red Square Advertiser/g' android/app/src/main/res/values/strings.xml
          else
            echo "strings.xml not found, creating it"
            mkdir -p android/app/src/main/res/values
            echo '<?xml version="1.0" encoding="utf-8"?><resources><string name="app_name">RedSquare Advertiser</string><string name="title_activity_main">RedSquare Advertiser</string><string name="package_name">app.redsquare.advertiser</string></resources>' > android/app/src/main/res/values/strings.xml
          fi

      - name: Create Android Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_SIGNING_KEY_BASE64 }}
        run: |
          if [ ! -z "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > android/app/release.keystore
          else
            echo "No keystore provided, using debug signing"
          fi

      - name: Build Advertiser Android APK
        run: |
          cd android
          # Verify gradlew exists before attempting to use it
          if [ ! -f "./gradlew" ]; then
            echo "ERROR: gradlew not found in android directory"
            echo "Contents of android directory:"
            ls -la
            exit 1
          fi
          
          ./gradlew assembleRelease
          echo "Listing build outputs:"
          find . -name "*.apk" -type f
          ls -la app/build/outputs/ || echo "outputs directory not found"
          ls -la app/build/outputs/apk/ || echo "apk directory not found"
          ls -la app/build/outputs/apk/release/ || echo "release directory not found"
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}

      - name: Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: advertiser-android-app
          path: android/app/build/outputs/apk/release/*.apk

      - name: Upload APK to Supabase Storage
        id: upload_apk
        run: |
          # Find the actual APK file
          FILE_PATH=$(find android/app/build/outputs/apk/release/ -name "*.apk" | head -1)
          if [ -z "$FILE_PATH" ]; then
            echo "No APK file found in release directory"
            exit 1
          fi
          echo "Found APK: $FILE_PATH"
          
          FILE_NAME="redsquare-advertiser-android-v${{ steps.build_info.outputs.version }}.apk"
          SUPABASE_BUCKET="apk-files"

          BUCKET_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/${SUPABASE_BUCKET}/${FILE_NAME}"
          echo "artifact_url=$BUCKET_URL" >> $GITHUB_OUTPUT

          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/${SUPABASE_BUCKET}/${FILE_NAME}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/vnd.android.package-archive" \
            --data-binary @"$FILE_PATH"

      - name: Update Build Status to 'Success'
        if: success()
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            --data '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "success",
              "artifact_url": "${{ steps.upload_apk.outputs.artifact_url }}"
            }'

      - name: Update Build Status to 'Failed'
        if: failure() || cancelled()
        run: |
          STATUS="failed"
          if [ "${{ job.status }}" == "cancelled" ]; then
            STATUS="cancelled"
          fi
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            --data-binary '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "'$STATUS'"
            }'