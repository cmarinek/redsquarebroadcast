name: Build RedSquare Screens (Android Mobile)

on:
  repository_dispatch:
    types: [trigger-screens-android-mobile-build]
  workflow_dispatch:
    inputs:
      build_id:
        description: 'ID of the build record in the database'
        required: true
      version:
        description: 'Version for this build'
        required: true
        default: '1.0.0-manual'

env:
  VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
  VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
  VITE_SUPABASE_PROJECT_ID: ${{ secrets.VITE_SUPABASE_PROJECT_ID }}
  VITE_MAPBOX_PUBLIC_TOKEN: ${{ secrets.VITE_MAPBOX_PUBLIC_TOKEN }}
  VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}
  SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  MAPBOX_PUBLIC_TOKEN: ${{ secrets.VITE_MAPBOX_PUBLIC_TOKEN }}
  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
  HUGGING_FACE_ACCESS_TOKEN: ${{ secrets.HUGGING_FACE_ACCESS_TOKEN }}
  GH_ACCESS_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
  GH_REPO_OWNER: ${{ secrets.GH_REPO_OWNER }}
  GH_REPO_NAME: ${{ secrets.GH_REPO_NAME }}

jobs:
  build-screens-android-mobile:
    runs-on: ubuntu-latest
    steps:
      - name: Get Build Info from Dispatch
        id: build_info
        run: |
          if [ -n "${{ github.event.client_payload.build_id }}" ]; then
            echo "build_id=${{ github.event.client_payload.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "triggered_by=${{ github.event.client_payload.triggered_by }}" >> $GITHUB_OUTPUT
            echo "commit_sha=${{ github.event.client_payload.commit_sha }}" >> $GITHUB_OUTPUT
          else
            echo "build_id=${{ github.event.inputs.build_id }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "triggered_by=manual" >> $GITHUB_OUTPUT
            echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi
          
          echo "üìã Build Info:"
          echo "  - Build ID: $(cat $GITHUB_OUTPUT | grep build_id | cut -d= -f2)"
          echo "  - Version: $(cat $GITHUB_OUTPUT | grep version | cut -d= -f2)"
          echo "  - Triggered by: $(cat $GITHUB_OUTPUT | grep triggered_by | cut -d= -f2)"

      - name: Update Build Status to 'In Progress'
        if: "!startsWith(steps.build_info.outputs.build_id, 'auto-')"
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "in_progress",
              "logs_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "commit_hash": "${{ github.sha }}"
            }'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Build Web App
        run: npm run build:mobile
        env:
          VITE_BUILD_TARGET: mobile
          VITE_CAPACITOR: 'true'

      - name: Validate build assets
        run: |
          echo "Checking for absolute asset paths in build..."
          if grep -r '"/assets' dist/ 2>/dev/null; then
            echo "‚ùå Found absolute /assets paths in build - this will cause issues in Capacitor apps"
            echo "Build artifacts should use relative paths for compatibility"
            exit 1
          fi
          echo "‚úÖ Build validation passed - no absolute asset paths found"

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Capacitor Android Platform
        run: |
          if [ ! -f "android/gradlew" ] || [ ! -f "android/build.gradle" ]; then
            echo "Android project incomplete, removing and re-adding platform"
            rm -rf android
            npx cap add android
            if [ ! -f "android/gradlew" ]; then
              echo "ERROR: Failed to create Android platform"
              exit 1
            fi
          else
            echo "Android platform properly configured, skipping add"
          fi

      - name: Sync Capacitor Project
        run: |
          npx cap sync android
          if [ -f "android/gradlew" ]; then
            chmod +x android/gradlew
            echo "Android gradlew found and made executable"
          else
            echo "ERROR: gradlew still not found after sync"
            exit 1
          fi

      - name: Configure Android Build for Mobile
        run: |
          # Configure for mobile/tablet usage (touchscreen required)
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
            sed -i 's/android:required="false"/android:required="true"/' android/app/src/main/AndroidManifest.xml || echo "Touchscreen already configured"
          fi

      - name: Create Android Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_SIGNING_KEY_BASE64 }}
        run: |
          if [ ! -z "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > android/app/release.keystore
          else
            echo "No keystore provided, using debug signing"
          fi

      - name: Build RedSquare Screens Android Mobile APK and AAB
        run: |
          set -e  # Exit on any error
          echo "Building RedSquare Screens Android Mobile APK and AAB..."
          cd android
          
          # Clean previous builds
          ./gradlew clean
          
          # Build APK with detailed output
          echo "Building APK..."
          ./gradlew assembleRelease --info --stacktrace
          
          # Build AAB (Android App Bundle) for Play Store
          echo "Building AAB for Play Store..."
          ./gradlew bundleRelease --info --stacktrace
          
          echo "Listing build outputs:"
          find . -name "*.apk" -type f
          find . -name "*.aab" -type f
          
          # Validate APK was created
          if [ ! -f "app/build/outputs/apk/release/app-release.apk" ] && [ ! -f "app/build/outputs/apk/release/app-release-unsigned.apk" ]; then
            echo "‚ùå APK file not found in expected location"
            exit 1
          fi
          
          # Validate AAB was created
          if [ ! -f "app/build/outputs/bundle/release/app-release.aab" ]; then
            echo "‚ùå AAB file not found in expected location"
            exit 1
          fi
          
          APK_PATH=$(find app/build/outputs/apk/release/ -name "*.apk" | head -1)
          APK_SIZE=$(stat -c%s "$APK_PATH" 2>/dev/null || stat -f%z "$APK_PATH")
          APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
          
          AAB_PATH="app/build/outputs/bundle/release/app-release.aab"
          AAB_SIZE=$(stat -c%s "$AAB_PATH" 2>/dev/null || stat -f%z "$AAB_PATH")
          AAB_SIZE_MB=$((AAB_SIZE / 1024 / 1024))
          
          echo "‚úÖ Android Mobile APK built successfully (${APK_SIZE_MB}MB)"
          echo "‚úÖ Android Mobile AAB built successfully (${AAB_SIZE_MB}MB)"
          
          # Validate sizes
          if [ $APK_SIZE_MB -gt 200 ]; then
            echo "‚ö†Ô∏è Warning: APK size is quite large (${APK_SIZE_MB}MB)"
          fi
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_SIGNING_KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_SIGNING_STORE_PASSWORD }}

      - name: Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screens-android-mobile-apk
          path: android/app/build/outputs/apk/release/*.apk

      - name: Upload AAB as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: screens-android-mobile-aab
          path: android/app/build/outputs/bundle/release/*.aab

      - name: Upload APK to Supabase Storage
        id: upload_apk
        run: |
          FILE_PATH=$(find android/app/build/outputs/apk/release/ -name "*.apk" | head -1)
          if [ -z "$FILE_PATH" ]; then
            echo "No APK file found in release directory"
            exit 1
          fi
          echo "Found APK: $FILE_PATH"
          
          FILE_NAME="screens-android-mobile-app-v${{ steps.build_info.outputs.version }}.apk"
          SUPABASE_BUCKET="apk-files"

          BUCKET_URL="${{ secrets.SUPABASE_URL }}/storage/v1/object/public/${SUPABASE_BUCKET}/${FILE_NAME}"
          echo "artifact_url=$BUCKET_URL" >> $GITHUB_OUTPUT

          curl -X POST \
            "${{ secrets.SUPABASE_URL }}/storage/v1/object/${SUPABASE_BUCKET}/${FILE_NAME}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/vnd.android.package-archive" \
            --data-binary @"$FILE_PATH"

      - name: Setup Google Play Service Account
        if: env.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON != '' && env.ANDROID_SIGNING_KEY_BASE64 != ''
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "Setting up Google Play Console API credentials..."
          
          # Save service account JSON to file
          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" > service-account.json
          
          echo "‚úÖ Google Play service account configured"

      - name: Upload to Google Play Internal Testing
        if: env.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON != '' && env.ANDROID_SIGNING_KEY_BASE64 != ''
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          GOOGLE_PLAY_PACKAGE_NAME: ${{ secrets.GOOGLE_PLAY_PACKAGE_NAME }}
          GOOGLE_PLAY_TRACK: ${{ secrets.GOOGLE_PLAY_TRACK || 'internal' }}
        run: |
          set -e  # Exit on any error
          echo "üì§ Uploading AAB to Google Play Console..."
          
          AAB_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          TRACK="${GOOGLE_PLAY_TRACK}"
          
          if [ ! -f "$AAB_PATH" ]; then
            echo "‚ùå AAB file not found: $AAB_PATH"
            exit 1
          fi
          
          echo "Uploading to track: $TRACK"
          
          # Install Python dependencies for API fallback
          pip3 install --quiet PyJWT requests cryptography
          
          # Use Play Developer API directly via Python
          python3 << 'PYTHON_SCRIPT'
          import json
          import jwt
          import time
          import requests
          import os
          import sys
          
          # Load service account
          with open('service-account.json') as f:
              sa = json.load(f)
          
          # Generate JWT token
          now = int(time.time())
          payload = {
              'iss': sa['client_email'],
              'sub': sa['client_email'],
              'aud': 'https://oauth2.googleapis.com/token',
              'iat': now,
              'exp': now + 3600,
              'scope': 'https://www.googleapis.com/auth/androidpublisher'
          }
          
          token = jwt.encode(payload, sa['private_key'], algorithm='RS256')
          
          # Get access token
          response = requests.post('https://oauth2.googleapis.com/token', data={
              'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',
              'assertion': token
          })
          
          if response.status_code != 200:
              print(f"‚ùå Failed to get access token: {response.text}")
              sys.exit(1)
          
          access_token = response.json()['access_token']
          print("‚úÖ Access token obtained")
          
          # Create edit
          package_name = os.environ['GOOGLE_PLAY_PACKAGE_NAME']
          headers = {
              'Authorization': f'Bearer {access_token}',
              'Content-Type': 'application/json'
          }
          
          response = requests.post(
              f'https://androidpublisher.googleapis.com/androidpublisher/v3/applications/{package_name}/edits',
              headers=headers
          )
          
          if response.status_code != 200:
              print(f"‚ùå Failed to create edit: {response.text}")
              sys.exit(1)
          
          edit_id = response.json()['id']
          print(f"‚úÖ Created edit: {edit_id}")
          
          # Upload bundle
          aab_path = 'android/app/build/outputs/bundle/release/app-release.aab'
          with open(aab_path, 'rb') as f:
              aab_data = f.read()
          
          response = requests.post(
              f'https://androidpublisher.googleapis.com/upload/androidpublisher/v3/applications/{package_name}/edits/{edit_id}/bundles?uploadType=media',
              headers={'Authorization': f'Bearer {access_token}', 'Content-Type': 'application/octet-stream'},
              data=aab_data
          )
          
          if response.status_code not in [200, 201]:
              print(f"‚ùå Failed to upload bundle: {response.text}")
              sys.exit(1)
          
          version_code = response.json().get('versionCode')
          print(f"‚úÖ Uploaded bundle with version code: {version_code}")
          
          # Assign to track
          track = os.environ['GOOGLE_PLAY_TRACK']
          track_data = {
              'releases': [{
                  'versionCodes': [str(version_code)],
                  'status': 'completed'
              }]
          }
          
          response = requests.put(
              f'https://androidpublisher.googleapis.com/androidpublisher/v3/applications/{package_name}/edits/{edit_id}/tracks/{track}',
              headers=headers,
              json=track_data
          )
          
          if response.status_code != 200:
              print(f"‚ùå Failed to assign to track: {response.text}")
              sys.exit(1)
          
          print(f"‚úÖ Assigned to {track} track")
          
          # Commit edit
          response = requests.post(
              f'https://androidpublisher.googleapis.com/androidpublisher/v3/applications/{package_name}/edits/{edit_id}:commit',
              headers=headers
          )
          
          if response.status_code != 200:
              print(f"‚ùå Failed to commit edit: {response.text}")
              sys.exit(1)
          
          print("‚úÖ Edit committed successfully")
          PYTHON_SCRIPT
          
          echo ""
          echo "‚úÖ Successfully uploaded to Google Play $TRACK track!"
          echo "üì± The build will appear in Play Console within a few minutes."
          echo "üß™ Once processed, you can distribute to testers."
          
          # Set output for build summary
          echo "play_store_uploaded=true" >> $GITHUB_OUTPUT
          echo "play_store_track=$TRACK" >> $GITHUB_OUTPUT
        id: play_store_upload

      - name: Update Build Status to 'Success'
        if: success() && !startsWith(steps.build_info.outputs.build_id, 'auto-')
        run: |
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "success",
              "artifact_url": "${{ steps.upload_apk.outputs.artifact_url }}"
            }'

      - name: Update Build Status to 'Failed'
        if: (failure() || cancelled()) && !startsWith(steps.build_info.outputs.build_id, 'auto-')
        run: |
          STATUS="failed"
          if [ "${{ job.status }}" == "cancelled" ]; then
            STATUS="cancelled"
          fi
          curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" \
            -H "Authorization: Bearer ${{ secrets.GH_ACTION_SECRET }}" \
            -H "Content-Type: application/json" \
            -d '{
              "build_id": "${{ steps.build_info.outputs.build_id }}",
              "status": "'$STATUS'"
            }'

      - name: Build Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "## ‚úÖ Android Mobile Build Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Build Details:**" >> $GITHUB_STEP_SUMMARY
            echo "- Build ID: \`${{ steps.build_info.outputs.build_id }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Version: \`${{ steps.build_info.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Platform: Android Mobile" >> $GITHUB_STEP_SUMMARY
            echo "- Triggered by: ${{ steps.build_info.outputs.triggered_by }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.play_store_upload.outputs.play_store_uploaded }}" == "true" ]; then
              echo "**üöÄ Google Play Deployment:**" >> $GITHUB_STEP_SUMMARY
              echo "- ‚úÖ Uploaded to Google Play \`${{ steps.play_store_upload.outputs.play_store_track }}\` track successfully" >> $GITHUB_STEP_SUMMARY
              echo "- üì± Build will be available in Play Console within a few minutes" >> $GITHUB_STEP_SUMMARY
              echo "- üß™ Once processed, distribute to testers in [Play Console](https://play.google.com/console)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "**Download Builds:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to the [Artifacts section](#artifacts) above" >> $GITHUB_STEP_SUMMARY
            echo "2. Download \`screens-android-mobile-apk\` (APK for direct install)" >> $GITHUB_STEP_SUMMARY
            echo "3. Download \`screens-android-mobile-aab\` (AAB for Play Store)" >> $GITHUB_STEP_SUMMARY
            echo "4. Extract and install on your Android device" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Android Mobile Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Build Details:**" >> $GITHUB_STEP_SUMMARY
            echo "- Build ID: \`${{ steps.build_info.outputs.build_id }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Version: \`${{ steps.build_info.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup
        if: always()
        run: |
          # Remove sensitive files
          rm -f service-account.json android/app/release.keystore