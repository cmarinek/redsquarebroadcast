name: Build RedSquare Screens (Windows)

on:
  repository_dispatch:
    types: [trigger-screens-windows-build]
  workflow_dispatch:
    inputs:
      build_id:
        description: 'ID of the build record in the database'
        required: true
      version:
        description: 'Version for this build'
        required: true
        default: '1.0.0-manual'

jobs:
  build-screens-windows:
    runs-on: windows-latest
    steps:
      - name: Get Build Info from Dispatch
        id: build_info
        run: |
          if ($env:GITHUB_EVENT_NAME -eq "repository_dispatch") {
            $payload = Get-Content $env:GITHUB_EVENT_PATH | ConvertFrom-Json
            echo "build_id=$($payload.client_payload.build_id)" >> $env:GITHUB_OUTPUT
            echo "version=$($payload.client_payload.version)" >> $env:GITHUB_OUTPUT
          } else {
            echo "build_id=${{ github.event.inputs.build_id }}" >> $env:GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      - name: Update Build Status to 'In Progress'
        run: |
          $supabaseUrl = "${{ secrets.SUPABASE_URL }}"
          if ([string]::IsNullOrEmpty($supabaseUrl)) {
            Write-Error "SUPABASE_URL secret not set"
            exit 1
          }
          
          $body = @{
            build_id = "${{ steps.build_info.outputs.build_id }}";
            status = "in_progress";
            logs_url = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}";
            commit_hash = "${{ github.sha }}";
          } | ConvertTo-Json -Compress

          Invoke-RestMethod -Uri "${supabaseUrl}/functions/v1/update-build-status" `
            -Method POST `
            -Headers @{
              "Authorization" = "Bearer ${{ secrets.GH_ACTION_SECRET }}";
              "Content-Type" = "application/json";
            } `
            -Body $body
        shell: pwsh

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Build Desktop App
        run: |
          # Build with optimizations to reduce file size
          npm run electron:build -- --win --x64 --config electron-builder.json --config.compression=maximum --config.nsis.differentialPackage=false
          
          # Check if build was successful
          $file = Get-ChildItem -Path release -Filter "*.exe" | Select-Object -First 1
          if (-not $file) {
            Write-Error "No executable file found in release directory"
            exit 1
          }
          
          # Check file size (500MB limit)
          $fileSizeMB = [math]::Round($file.Length / 1MB, 2)
          Write-Host "Built executable size: $fileSizeMB MB"
          
          if ($file.Length -gt 500000000) {
            Write-Warning "File size ($fileSizeMB MB) exceeds 500MB limit. Consider optimizing the build."
            # List largest files in the app for debugging
            Write-Host "Analyzing app directory structure..."
            if (Test-Path "release\win-unpacked") {
              Get-ChildItem -Path "release\win-unpacked" -Recurse | Sort-Object Length -Descending | Select-Object -First 10 | Format-Table Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}}
            }
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # electron-builder may need this to download binaries
        shell: pwsh

      - name: Create and Upload Artifact Zip
        id: upload_artifact
        run: |
          $file = Get-ChildItem -Path release -Filter "*.exe" | Select-Object -First 1
          if (-not $file) {
            Write-Error "No .exe file found in release directory"
            exit 1
          }
          
          $fileName = $file.Name
          $filePath = $file.FullName
          $fileSizeMB = [math]::Round($file.Length / 1MB, 2)
          $fileSizeBytes = $file.Length
          
          Write-Host "Original file: $fileName (${fileSizeMB}MB)"
          Write-Host "File size in bytes: $fileSizeBytes"
          
          # Check file size limit (80MB = 83,886,080 bytes to be safe)
          if ($fileSizeBytes -gt 83886080) {
            Write-Error "File size (${fileSizeMB}MB) exceeds safe upload limit of 80MB. Build optimization needed."
            exit 1
          }
          
          # Create 7z archive for better compression
          $zipName = "RedSquare-Screens-Windows-v${{ steps.build_info.outputs.version }}.7z"
          $zipPath = Join-Path $env:TEMP $zipName
          
          Write-Host "Creating 7z archive: $zipName"
          
          # Install 7-Zip if not available
          if (-not (Get-Command "7z" -ErrorAction SilentlyContinue)) {
            Write-Host "Installing 7-Zip..."
            choco install 7zip -y
            $env:PATH += ";C:\Program Files\7-Zip"
          }
          
          # Create 7z archive with maximum compression
          & 7z a -t7z -m0=lzma2 -mx=9 -mfb=64 -md=32m -ms=on "$zipPath" "$filePath"
          
          # Check 7z file size
          $zipFile = Get-Item $zipPath
          $zipSizeMB = [math]::Round($zipFile.Length / 1MB, 2)
          $compressionRatio = [math]::Round((1 - $zipFile.Length / $file.Length) * 100, 1)
          Write-Host "7z archive created: $zipName (${zipSizeMB}MB) - Compression ratio: ${compressionRatio}%"
          
          # Final size check for 7z file (75MB = 78,643,200 bytes to be extra safe)
          if ($zipFile.Length -gt 78643200) {
            Write-Error "7z archive size (${zipSizeMB}MB) still exceeds safe limit of 75MB. Further optimization needed."
            exit 1
          }
          
          # Upload using resumable upload script
          Write-Host "Uploading with resumable upload..."
          node scripts/resumable-upload.js "$zipPath" "app_artifacts" "$zipName" "${{ secrets.SUPABASE_URL }}" "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          
          # Read the result URL
          $result = Get-Content "upload-result.txt"
          if ($result -eq "UPLOAD_FAILED" -or $result -eq "SIZE_LIMIT_EXCEEDED") {
            Write-Error "Build artifact upload failed. File size: ${zipSizeMB}MB may exceed storage limits."
            Write-Host "Consider further reducing build size by:"
            Write-Host "- Excluding more node_modules content"
            Write-Host "- Using better compression" 
            Write-Host "- Removing unnecessary dependencies"
            exit 1
          }
          
          echo "artifact_url=$result" >> $env:GITHUB_OUTPUT
          Write-Host "7z archive uploaded successfully using resumable upload!"
          Write-Host "Artifact URL: $result"
          
          # Clean up temp files
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
            Write-Host "Temporary 7z file cleaned up"
          }
          if (Test-Path "upload-result.txt") {
            Remove-Item "upload-result.txt" -Force
          }
        shell: pwsh

      - name: Update Build Status to 'Success'
        if: success()
        run: |
          $body = @{
            build_id = "${{ steps.build_info.outputs.build_id }}";
            status = "success";
            artifact_url = "${{ steps.upload_artifact.outputs.artifact_url }}";
          } | ConvertTo-Json -Compress

          Invoke-RestMethod -Uri "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" `
            -Method POST `
            -Headers @{
              "Authorization" = "Bearer ${{ secrets.GH_ACTION_SECRET }}";
              "Content-Type" = "application/json";
            } `
            -Body $body
        shell: pwsh

      - name: Update Build Status to 'Failed'
        if: failure() || cancelled()
        run: |
          $status = "failed"
          if ("${{ job.status }}" -eq "cancelled") {
            $status = "cancelled"
          }
          $body = @{
            build_id = "${{ steps.build_info.outputs.build_id }}";
            status = $status;
          } | ConvertTo-Json -Compress

          Invoke-RestMethod -Uri "${{ secrets.SUPABASE_URL }}/functions/v1/update-build-status" `
            -Method POST `
            -Headers @{
              "Authorization" = "Bearer ${{ secrets.GH_ACTION_SECRET }}";
              "Content-Type" = "application/json";
            } `
            -Body $body
        shell: pwsh
