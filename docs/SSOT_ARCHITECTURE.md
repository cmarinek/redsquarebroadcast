# Single Source of Truth (SSOT) Architecture

## Overview

Red Square uses a **strict SSOT architecture** to prevent configuration drift, reduce errors, and improve maintainability at scale. All configuration values have exactly **one authoritative source**, and all other occurrences are **derived** from that source.

---

## The Problem We're Solving

### Before SSOT:

**Configuration scattered everywhere:**
```
App name: "RedSquare" (capacitor.config.json)
App name: "Red Square" (manifest.json)  
App name: "RedSquare Screens" (electron-builder.json)
App ID: "com.redsquare.screens" (workflow files)
App ID: "app.redsquare.broadcast" (capacitor.config.json)
Supabase ID: "hqeyyutbuxhyildsasqq" (hardcoded in 50+ files)
```

**Result**: Errors, inconsistencies, maintenance nightmare

### After SSOT:

**All config in one place:**
```json
// ssot.config.json
{
  "applications": {
    "platform": {
      "name": "Red Square",
      "bundleId": "app.redsquare.platform"
    }
  }
}
```

**All other files generated from this:** ‚úÖ Zero drift, single update point

---

## Architecture

### The Three Layers

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Layer 1: SSOT (Single Source of Truth)    ‚îÇ
‚îÇ  File: ssot.config.json                     ‚îÇ
‚îÇ  - Hand-edited by developers                ‚îÇ
‚îÇ  - Version controlled                        ‚îÇ
‚îÇ  - Machine-readable JSON                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Layer 2: Generators                        ‚îÇ
‚îÇ  Script: scripts/ssot-generator.js          ‚îÇ
‚îÇ  - Reads ssot.config.json                   ‚îÇ
‚îÇ  - Generates all derivative configs         ‚îÇ
‚îÇ  - Never edited manually                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Layer 3: Generated Configs                 ‚îÇ
‚îÇ  Files: capacitor.config.json, etc.         ‚îÇ
‚îÇ  - Generated by Layer 2                      ‚îÇ
‚îÇ  - Never edited manually                     ‚îÇ
‚îÇ  - Validated by ssot-validator.js            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Core Principles

### 1. One Truth, Many Representations

**Bad (multiple sources of truth):**
```
capacitor.config.json: { appId: "com.redsquare.screens" }
electron-builder.json: { appId: "app.redsquare.platform" }
manifest.json: { name: "RedSquare" }
```

**Good (one source, multiple derivations):**
```
ssot.config.json: { bundleId: "app.redsquare.platform" }
  ‚Üì generates ‚Üí
capacitor.config.json: { appId: "app.redsquare.platform" }
electron-builder.json: { appId: "app.redsquare.platform" }
manifest.json: { name: "Red Square" }
```

### 2. Edit Source, Generate Derivatives

**Workflow:**
```bash
# 1. Edit the SSOT
vim ssot.config.json

# 2. Generate all configs
npm run generate-configs

# 3. Validate integrity
npm run validate-ssot

# 4. Commit everything
git add ssot.config.json capacitor.config.json electron-builder.json
git commit -m "Update app name to Red Square Platform"
```

### 3. Validate Before Build

**Pre-build validation:**
```json
// package.json
{
  "scripts": {
    "prebuild": "node scripts/ssot-validator.js",
    "build": "vite build"
  }
}
```

**Result:** Build fails if configs are inconsistent

---

## Files & Responsibilities

### SSOT Layer

| File | Purpose | Editable? |
|------|---------|-----------|
| `ssot.config.json` | Master configuration | ‚úÖ YES |
| `ssot.schema.json` | JSON schema for validation | ‚úÖ YES |

### Generator Layer

| File | Purpose | Run When |
|------|---------|----------|
| `scripts/ssot-generator.js` | Generates all configs | After editing SSOT |
| `scripts/ssot-validator.js` | Validates consistency | Before builds/commits |

### Generated Layer (DO NOT EDIT)

| File | Generated From | Auto-Generated? |
|------|---------------|-----------------|
| `capacitor.config.json` | `applications.platform` | ‚úÖ YES |
| `electron-builder.json` | `applications.screens` | ‚úÖ YES |
| `public/manifest.json` | `applications.platform` | ‚úÖ YES |
| `.env.example` | `backend`, `integrations` | ‚úÖ YES |
| `src/config/ssot.generated.ts` | Entire SSOT | ‚úÖ YES |

---

## Usage Guide

### Making Configuration Changes

#### Step 1: Edit SSOT
```bash
# Edit the master config
vim ssot.config.json

# Example change:
{
  "applications": {
    "platform": {
      "name": "Red Square Platform",  # Changed
      "bundleId": "app.redsquare.platform"
    }
  }
}
```

#### Step 2: Generate Configs
```bash
npm run generate-configs
# or
node scripts/ssot-generator.js
```

**Output:**
```
‚úÖ Generated: Capacitor Config (Platform App)
‚úÖ Generated: Electron Builder Config
‚úÖ Generated: PWA Manifest
‚úÖ Generated: Environment Variables Example
‚úÖ Generated: TypeScript SSOT Constants
```

#### Step 3: Validate
```bash
npm run validate-ssot
# or
node scripts/ssot-validator.js
```

**Output:**
```
‚úÖ All checks passed! SSOT integrity maintained.
```

#### Step 4: Commit
```bash
git add ssot.config.json capacitor.config.json electron-builder.json public/manifest.json
git commit -m "feat: Rename to Red Square Platform"
```

---

## Common Scenarios

### Changing App Name

```json
// ssot.config.json
{
  "applications": {
    "platform": {
      "name": "New Name Here"  // Change this
    }
  }
}
```

Then run:
```bash
npm run generate-configs
```

**Updates automatically:**
- Capacitor config
- Electron config
- PWA manifest
- TypeScript constants

### Adding New Supabase Project

```json
// ssot.config.json
{
  "backend": {
    "supabase": {
      "projectId": "newprojectid123",
      "url": "https://newprojectid123.supabase.co"
    }
  }
}
```

Then run:
```bash
npm run generate-configs
```

**Updates automatically:**
- Environment example file
- TypeScript constants
- Documentation references

### Changing Brand Colors

```json
// ssot.config.json
{
  "assets": {
    "brand": {
      "primaryColor": "#1e40af",
      "secondaryColor": "#64748b"
    }
  }
}
```

Then run:
```bash
npm run generate-configs
```

**Updates automatically:**
- PWA manifest theme color
- Splash screen colors
- TypeScript constants

---

## Validation Rules

### Error-Level Violations

These will **fail the build**:

1. **App ID mismatch** between SSOT and configs
2. **Missing required environment variables**
3. **Incorrect Supabase project references**
4. **Version number inconsistencies**

### Warning-Level Issues

These will **show warnings** but not fail:

1. **Brand color mismatches**
2. **Copyright text differences**
3. **Minor naming inconsistencies**
4. **Hardcoded values in many files**

---

## Integration with Build System

### Pre-build Validation

```json
// package.json
{
  "scripts": {
    "prebuild": "npm run validate-ssot",
    "build": "vite build",
    "validate-ssot": "node scripts/ssot-validator.js",
    "generate-configs": "node scripts/ssot-generator.js"
  }
}
```

### Pre-commit Hook

```bash
# .githooks/pre-commit
#!/bin/bash

echo "Validating SSOT integrity..."
node scripts/ssot-validator.js

if [ $? -ne 0 ]; then
  echo "‚ùå SSOT validation failed. Run: npm run generate-configs"
  exit 1
fi
```

### CI/CD Pipeline

```yaml
# .github/workflows/ci.yml
- name: Validate SSOT
  run: npm run validate-ssot
  
- name: Build
  run: npm run build
```

---

## Benefits

### 1. Zero Configuration Drift
- ‚úÖ All configs stay in sync automatically
- ‚úÖ No more "works on my machine" issues
- ‚úÖ Consistent across all platforms

### 2. Easier Refactoring
- ‚úÖ Change app name once, updates everywhere
- ‚úÖ Update Supabase project in one place
- ‚úÖ Rebrand with single config change

### 3. Fewer Bugs
- ‚úÖ Validation catches inconsistencies early
- ‚úÖ No typos in duplicated values
- ‚úÖ Type-safe constants in TypeScript

### 4. Better Onboarding
- ‚úÖ New developers know where to edit
- ‚úÖ Clear documentation of config source
- ‚úÖ Automated setup reduces errors

### 5. Scalability
- ‚úÖ Add new platforms easily
- ‚úÖ Support multiple apps/brands
- ‚úÖ Maintain consistency as team grows

---

## Advanced Usage

### Multiple Apps

```json
// ssot.config.json
{
  "applications": {
    "platform": { ... },   // User-facing app
    "screens": { ... },    // Screen owner app
    "admin": { ... }       // Admin dashboard
  }
}
```

Generate specific app:
```bash
node scripts/ssot-generator.js --app=platform
```

### Environment-Specific Configs

```json
// ssot.config.json
{
  "domains": {
    "production": "redsquare.app",
    "staging": "staging.redsquare.app",
    "development": "localhost:8080"
  }
}
```

Access in code:
```typescript
import { SSOT_CONFIG } from '@/config/ssot.generated';

const apiUrl = SSOT_CONFIG.domains[process.env.NODE_ENV];
```

### Custom Validations

Add to `scripts/ssot-validator.js`:
```javascript
function validateCustomRule(ssot, report) {
  if (ssot.monetization.platformFeePercent > 30) {
    report.addWarning('Platform fee >30% may reduce adoption');
  }
}
```

---

## Troubleshooting

### "Generated files out of sync"

**Solution:**
```bash
npm run generate-configs
git add .
git commit -m "sync: Regenerate configs from SSOT"
```

### "Validation fails but I don't know why"

**Solution:**
```bash
# Run validator in verbose mode
npm run validate-ssot -- --verbose

# Check specific file
git diff capacitor.config.json
```

### "I edited a generated file by mistake"

**Solution:**
```bash
# Regenerate from SSOT (overwrites changes)
npm run generate-configs

# Or restore from git
git checkout capacitor.config.json
```

### "I need to temporarily break SSOT"

**Solution:**
```bash
# Disable validation for one commit
git commit --no-verify -m "WIP: Testing config change"

# Remember to fix before merge!
```

---

## Best Practices

### DO:
‚úÖ Edit `ssot.config.json` for all config changes  
‚úÖ Run generator after every SSOT edit  
‚úÖ Commit SSOT and generated files together  
‚úÖ Add validation to CI/CD pipeline  
‚úÖ Document custom SSOT fields  

### DON'T:
‚ùå Manually edit generated config files  
‚ùå Skip validation before builds  
‚ùå Commit SSOT without regenerating  
‚ùå Hardcode values in code  
‚ùå Bypass validation in production  

---

## Migration Guide

### Migrating Existing Project

1. **Create SSOT config:**
   ```bash
   # Use existing values as starting point
   cp ssot.config.example.json ssot.config.json
   vim ssot.config.json  # Fill in actual values
   ```

2. **Generate configs:**
   ```bash
   npm run generate-configs
   ```

3. **Compare changes:**
   ```bash
   git diff capacitor.config.json
   git diff electron-builder.json
   # Review all changes carefully
   ```

4. **Fix inconsistencies:**
   ```bash
   # Update SSOT with correct values
   vim ssot.config.json
   npm run generate-configs
   ```

5. **Validate:**
   ```bash
   npm run validate-ssot
   ```

6. **Commit:**
   ```bash
   git add ssot.config.json scripts/ssot-*.js
   git add capacitor.config.json electron-builder.json
   git commit -m "feat: Implement SSOT architecture"
   ```

---

## Future Enhancements

- [ ] JSON schema validation for ssot.config.json
- [ ] IDE autocomplete for SSOT fields
- [ ] Visual config editor UI
- [ ] Git hooks to auto-generate on SSOT change
- [ ] Diff tool to compare SSOT versions
- [ ] Migration scripts for breaking changes
- [ ] SSOT versioning and backwards compatibility

---

## Support

### Questions?
- Check `docs/SSOT_MANIFEST.md` for field reference
- Run `npm run validate-ssot -- --help` for options
- Review generated files to understand mappings

### Issues?
- Run validator with `--verbose` flag
- Check git history for recent SSOT changes
- Compare against working branch

### Need Help?
- File issue with `[SSOT]` prefix
- Include validator output
- Share ssot.config.json (redact secrets)

---

**Remember:** SSOT is your friend. One source of truth = fewer bugs, easier scaling, happier developers! üéØ
